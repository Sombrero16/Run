<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gemini Idea Assistant</title>
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Load Inter font -->
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap');
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7f9fb;
        }
    </style>
</head>
<body class="min-h-screen flex items-center justify-center p-4">

    <div class="w-full max-w-3xl bg-white shadow-xl rounded-2xl p-6 md:p-10 border border-gray-100">
        <header class="text-center mb-8">
            <h1 class="text-3xl font-bold text-indigo-700">AI Idea Assistant</h1>
            <p class="text-gray-500 mt-2">Generate tailored, non-fixed content instantly using the Gemini API.</p>
        </header>

        <!-- User Input Area -->
        <div class="mb-6">
            <label for="userPrompt" class="block text-lg font-medium text-gray-700 mb-2">What idea do you want to generate?</label>
            <textarea id="userPrompt" rows="4" class="w-full p-3 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 shadow-sm"
                placeholder="E.g., Write three exciting plot twists for a futuristic detective story about time travel."></textarea>
        </div>

        <!-- Action Button and Loading Spinner -->
        <button id="generateBtn"
            class="w-full py-3 px-4 bg-indigo-600 text-white font-semibold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150 ease-in-out disabled:opacity-50 flex items-center justify-center">
            <svg id="loadingSpinner" class="animate-spin -ml-1 mr-3 h-5 w-5 text-white hidden" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            <span id="buttonText">Generate Idea</span>
        </button>

        <!-- Output Area -->
        <div class="mt-8">
            <h2 class="text-xl font-bold text-gray-700 mb-3 border-b pb-2">Generated Output:</h2>
            <div id="outputArea" class="min-h-32 p-4 bg-gray-50 border border-gray-200 rounded-lg whitespace-pre-wrap text-gray-800">
                <!-- AI generated content will appear here -->
                The generated content will be contextually unique based on your prompt.
            </div>
        </div>
    </div>

    <!-- Firebase and AI Logic -->
    <script type="module">
        // Mandatory Firebase Imports
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // --- GLOBAL SETUP (MANDATORY) ---
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : null;
        const initialAuthToken = typeof __initial_auth_token !== 'undefined' ? __initial_auth_token : null;

        let db = null;
        let auth = null;
        let isAuthReady = false;

        if (firebaseConfig) {
            setLogLevel('debug');
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
            auth = getAuth(app);
        }

        async function authenticateUser() {
            try {
                if (auth) {
                    if (initialAuthToken) {
                        await signInWithCustomToken(auth, initialAuthToken);
                    } else {
                        await signInAnonymously(auth);
                    }
                }
                isAuthReady = true;
            } catch (error) {
                console.error("Firebase authentication failed:", error);
            }
        }

        // Run authentication immediately
        authenticateUser();
        // --- END GLOBAL SETUP ---

        // --- AI GENERATION LOGIC ---
        const modelName = "gemini-2.5-flash-preview-09-2025";
        const apiKey = ""; // API key will be provided by the runtime environment
        const apiUrl = `https://generativelanguage.googleapis.com/v1beta/models/${modelName}:generateContent?key=${apiKey}`;

        const generateBtn = document.getElementById('generateBtn');
        const userPromptEl = document.getElementById('userPrompt');
        const outputArea = document.getElementById('outputArea');
        const loadingSpinner = document.getElementById('loadingSpinner');
        const buttonText = document.getElementById('buttonText');

        const MAX_RETRIES = 5;

        async function callGeminiApi(userQuery, retries = 0) {
            const systemPrompt = "You are a creative and helpful idea assistant. Respond directly to the user's request with a compelling, well-structured, and original output. Format your response clearly using Markdown.";

            const payload = {
                contents: [{ parts: [{ text: userQuery }] }],
                systemInstruction: { parts: [{ text: systemPrompt }] },
            };

            try {
                const response = await fetch(apiUrl, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify(payload)
                });

                if (!response.ok) {
                    if (response.status === 429 && retries < MAX_RETRIES) {
                        const delay = Math.pow(2, retries) * 1000;
                        console.warn(`Rate limit exceeded (429). Retrying in ${delay / 1000}s...`);
                        await new Promise(resolve => setTimeout(resolve, delay));
                        return callGeminiApi(userQuery, retries + 1); // Exponential backoff retry
                    }
                    throw new Error(`API call failed with status: ${response.status}`);
                }

                const result = await response.json();
                const text = result.candidates?.[0]?.content?.parts?.[0]?.text;
                return text || "Error: No text generated by the model.";

            } catch (error) {
                console.error("Gemini API request error:", error);
                return `An error occurred: ${error.message}`;
            }
        }

        async function generateIdea() {
            if (!isAuthReady) {
                outputArea.textContent = "Authentication is not yet ready. Please wait a moment and try again.";
                return;
            }

            const userQuery = userPromptEl.value.trim();
            if (userQuery === "") {
                outputArea.textContent = "Please enter a prompt to generate an idea.";
                return;
            }

            // Disable UI and show loading
            generateBtn.disabled = true;
            loadingSpinner.classList.remove('hidden');
            buttonText.textContent = "Generating...";
            outputArea.textContent = "Processing your request...";
            outputArea.classList.add('animate-pulse');

            const generatedText = await callGeminiApi(userQuery);

            // Re-enable UI and hide loading
            outputArea.classList.remove('animate-pulse');
            generateBtn.disabled = false;
            loadingSpinner.classList.add('hidden');
            buttonText.textContent = "Generate Idea";
            
            // Display output
            outputArea.textContent = generatedText;
        }

        // Attach event listener
        generateBtn.addEventListener('click', generateIdea);

    </script>
</body>
</html>
